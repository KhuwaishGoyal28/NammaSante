{% extends "base.html" %}
{% block title %}AI Crop Guidance Chatbot{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <h2 class="text-center mb-4 text-success"><i class="bi bi-robot"></i> AI Crop Guidance Chatbot</h2>

    <div class="card shadow-lg border-0 rounded-3">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Chat with AI Assistant</h5>
      </div>
      <div class="card-body" style="height: 500px; overflow-y: auto;" id="chat-messages">
        <div class="text-center text-muted">
          <i class="bi bi-robot display-4 mb-3"></i>
          <p>Hello! I'm your AI farming assistant. Ask me anything about crops, farming techniques, weather, or agriculture in general. I support multiple languages!</p>
        </div>
      </div>
      <div class="card-footer">
        <form id="chat-form" class="row g-2">
          <div class="col">
            <input type="text" id="message-input" class="form-control" placeholder="Type your farming question here..." required>
          </div>
          <div class="col-auto">
            <button type="button" id="voice-btn" class="btn btn-outline-success"><i class="bi bi-mic"></i></button>
            <button type="submit" class="btn btn-success"><i class="bi bi-send"></i></button>
          </div>
        </form>
      </div>
    </div>

    <div class="text-center mt-3">
      <a href="{{ url_for('food_chain') }}" class="btn btn-secondary btn-lg px-4"><i class="bi bi-arrow-left"></i> Back to Food Chain</a>
    </div>
  </div>
</div>

<script>
  const chatMessages = document.getElementById('chat-messages');
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');
  const voiceBtn = document.getElementById('voice-btn');

  let recognition;
  let isListening = false;

  // Initialize speech recognition
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'auto'; // Auto-detect language

    recognition.onstart = function() {
      isListening = true;
      voiceBtn.innerHTML = '<i class="bi bi-mic-fill text-danger"></i>';
      voiceBtn.classList.add('btn-danger');
    };

    recognition.onend = function() {
      isListening = false;
      voiceBtn.innerHTML = '<i class="bi bi-mic"></i>';
      voiceBtn.classList.remove('btn-danger');
    };

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      messageInput.value = transcript;
      // Auto-submit after voice input
      chatForm.dispatchEvent(new Event('submit'));
    };

    recognition.onerror = function(event) {
      console.error('Speech recognition error:', event.error);
      alert('Voice recognition error. Please try again or type your message.');
    };
  } else {
    voiceBtn.style.display = 'none';
  }

  voiceBtn.addEventListener('click', function() {
    if (isListening) {
      recognition.stop();
    } else {
      recognition.start();
    }
  });

  chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message
    addMessage(message, 'user');
    messageInput.value = '';

    // Show typing indicator
    const typingDiv = addTypingIndicator();

    try {
      const response = await fetch('/crop_guidance', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
      });

      const data = await response.json();
      typingDiv.remove();

      if (response.ok) {
        addMessage(data.response, 'bot');
        // Text-to-speech for bot response
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(data.response);
          utterance.lang = data.detected_lang || 'en';
          speechSynthesis.speak(utterance);
        }
      } else {
        addMessage('Sorry, I encountered an error. Please try again.', 'bot');
      }
    } catch (error) {
      typingDiv.remove();
      addMessage('Network error. Please check your connection and try again.', 'bot');
      console.error('Error:', error);
    }
  });

  function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `d-flex mb-3 ${sender === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
    messageDiv.innerHTML = `
      <div class="card ${sender === 'user' ? 'bg-success text-white' : 'bg-light'} border-0 rounded-3" style="max-width: 70%;">
        <div class="card-body p-3">
          <p class="mb-0">${text}</p>
        </div>
      </div>
    `;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function addTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'd-flex mb-3 justify-content-start';
    typingDiv.innerHTML = `
      <div class="card bg-light border-0 rounded-3" style="max-width: 70%;">
        <div class="card-body p-3">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return typingDiv;
  }
</script>

<style>
  .typing-indicator {
    display: flex;
    gap: 4px;
  }
  .typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #6c757d;
    animation: typing 1.4s infinite ease-in-out;
  }
  .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
  .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
  @keyframes typing {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }
</style>
{% endblock %}
