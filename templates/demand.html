{% extends "base.html" %}
{% block title %}Crop Demand Analysis{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <h2 class="text-center mb-4 text-success"><i class="bi bi-bar-chart-line"></i> Crop Demand Analysis</h2>

    <div class="card shadow-lg border-0 rounded-3 mb-4">
      <div class="card-body p-4">
        <form method="POST" class="row g-3">
          <div class="col-md-6">
            <label for="state" class="form-label fw-semibold">State</label>
            <select class="form-select form-select-lg" id="state" name="state" required onchange="updateCities()">
              <option value="">Select State</option>
              {% for state in state_city_mapping.keys() %}
              <option value="{{ state }}" {% if selected_state == state %}selected{% endif %}>{{ state }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="city" class="form-label fw-semibold">City</label>
            <select class="form-select form-select-lg" id="city" name="city" required>
              <option value="">Select City</option>
              {% for city in cities %}
              <option value="{{ city }}" {% if selected_city == city %}selected{% endif %}>{{ city }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 text-center">
            <button type="submit" class="btn btn-success btn-lg px-5"><i class="bi bi-graph-up"></i> Analyze Demand</button>
          </div>
        </form>
      </div>
    </div>

    {% if demand_data %}
    <div class="card shadow-lg border-0 rounded-3">
      <div class="card-body p-4">
        <h4 class="text-success mb-3"><i class="bi bi-clipboard-data"></i> Crop Demand Summary</h4>
        {% set total_quantity = 0 %}
        {% for item in demand_data %}
        {% set total_quantity = total_quantity + item.total_needed %}
        <div class="card mb-3 border-success">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h6 class="card-title mb-0"><i class="bi bi-tree"></i> {{ item.crop }}</h6>
              </div>
              <div class="col-md-4 text-end">
                <span class="badge bg-success fs-6">{{ "%.2f"|format(item.total_needed) }} tonnes needed</span>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        <div class="card bg-success text-white border-0">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h5 class="card-title mb-0"><i class="bi bi-calculator"></i> Total Quantity Needed</h5>
              </div>
              <div class="col-md-4 text-end">
                <span class="badge bg-light text-success fs-6 fw-bold">{{ "%.2f"|format(total_quantity) }} tonnes</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="text-center mt-4">
      <a href="{{ url_for('food_chain') }}" class="btn btn-secondary btn-lg px-4"><i class="bi bi-arrow-left"></i> Back to Food Chain</a>
    </div>
  </div>
</div>

<script>
  const stateCityMapping = {{ state_city_mapping | tojson }};

  function updateCities() {
    const stateSelect = document.getElementById('state');
    const citySelect = document.getElementById('city');
    const selectedState = stateSelect.value;

    citySelect.innerHTML = '<option value="">Select City</option>';

    if (selectedState && stateCityMapping[selectedState]) {
      stateCityMapping[selectedState].forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      });
    }
  }

  // Initialize cities on page load if state is selected
  document.addEventListener('DOMContentLoaded', function() {
    const stateSelect = document.getElementById('state');
    if (stateSelect.value) {
      updateCities();
    }
  });
</script>
{% endblock %}
